<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" class="h-100">
<!-- Head tag, using a fragment reference -->
<div th:replace="fragments/generic_head :: head('User management')"></div>

<!-- Internal styling for the Edit and Delete buttons -->
<style>
  .hover-button { opacity: 0; }
  tr:hover .hover-button { opacity: 1; }
</style>

<!-- Body contents -->
<body class="container h-100">
<div th:replace="fragments/navigation_bar :: navigation_bar"></div>

<div class="row h-100 justify-content-center align-items-baseline">
  <div class="col-lg-10 m-1 p-3 rounded" style="background: #eeeeee">

    <h1 class="text-center">Manage users</h1>
    <p>

    </p>

    <table class="table table-hover">
      <thead>
      <tr>
        <th scope="col">Username</th>
        <th scope="col">Role</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="u : ${users}">
        <td th:text="${u.username}"></td>
        <td th:text="${u.prettyRole}"></td>
        <td>
          <div class="float-end">
            <button type="button" class="btn btn-outline-primary me-1 hover-button"
                    data-bs-toggle="modal" data-bs-target="#editModal"
                    th:data-bs-id="${u.id}" th:data-bs-username="${u.username}"
                    th:data-bs-role="${u.role}" >
              Update Role
            </button>
            <button type="button" class="btn btn-outline-danger hover-button"
                    data-bs-toggle="modal" data-bs-target="#deleteModal"
                    th:data-bs-id="${u.id}">
              Delete
            </button>
          </div>
        </td>
      </tr>
      </tbody>
    </table>

  </div>
</div>

<!-- Bootstrap modal dialog for part editing -->
<div class="modal" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5">Update user's role</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="input_username" class="col-form-label">Username:</label>
          <input type="text" class="form-control" id="input_username" placeholder="username" readonly>
        </div>
        <div class="mb-3">
          <label for="edit_role" class="col-form-label">Username:</label>
          <select id="edit_role">
            <option th:each="r : ${roles}" th:text="${r.prettyString}" th:value="${r.toString()}" value="ADMINISTRATOR">Administrator</option>
          </select>
        </div>
        <div class="alert alert-danger" id="edit_fail_message" hidden>
          Could not update user!
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="clickedSave()">Update</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap modal dialog for part deletion. -->
<div class="modal" id="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5">Are you sure you want to delete this production goal?</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
        <button type="button" class="btn btn-primary" onclick="clickedDelete()">Yes</button>
      </div>
    </div>
  </div>
</div>

<!-- Additional scripts: Bootstrap and modal handling -->
<script th:src="@{/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/js/datasending.js}"></script>

<script>
  let selectedId = null;

  // Handles data fill for the edit modal.
  const editModal = document.getElementById("editModal");
  editModal.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;

    selectedId = button.getAttribute('data-bs-id');
    editModal.querySelector('#input_username').value = button.getAttribute('data-bs-username');
    editModal.querySelector('#edit_role').value = button.getAttribute('data-bs-role');
  });

  // Handles data fill for the delete modal.
  const deleteModal = document.getElementById("deleteModal");
  deleteModal.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;
    selectedId = button.getAttribute('data-bs-id');
  });

  // Handles deletion requests.
  function clickedDelete() {
    const dataToSend = {
      id: selectedId
    };

    sendDataAndDoOrElse('DELETE', '/production_goals', dataToSend,
            () => location.reload(),
            () => {}
    );
  }

  // Handles creation and edit requests.
  function clickedSave() {
    const dataToSend = {
      id: selectedId,
      username: document.getElementById('input_username').value,
      role: document.getElementById('edit_role').value
    };
    const method = 'PUT';
    sendDataAndDoOrElse(method, '/user_management', dataToSend,
            () => location.reload(),
            () => document.getElementById("edit_fail_message").removeAttribute("hidden")
    );
  }
</script>
</body>
</html>
